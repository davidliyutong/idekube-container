name: Build and Publish QEMU Images

on:
  workflow_dispatch:
    inputs:
      branches:
        description: 'QEMU branches to build (comma-separated, e.g., "featured/base,featured/kathara")'
        required: false
        default: 'featured/base,featured/kathara'
  release:
    types: [published]

env:
  REGISTRY: docker.io
  AUTHOR: davidliyutong
  NAME: idekube-container

jobs:
  publish-qemu-base:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch:
          - featured/base
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          make set_type TYPE=base

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-system-arm \
            qemu-utils \
            cloud-image-utils \
            ansible \
            sshpass \
            rsync \
            python3-pip
          pip3 install vcstool

      - name: Cache QEMU files
        uses: actions/cache@v3
        with:
          path: |
            .cache/qemu_files
            .cache/qemu_images
          key: qemu-cache-${{ runner.os }}-${{ hashFiles('scripts/shell/prepare_qemu_files.sh', 'scripts/shell/prepare_qemu_images.sh') }}
          restore-keys: |
            qemu-cache-${{ runner.os }}-

      - name: Build and publish QEMU image for ${{ matrix.branch }}
        run: |
          export BRANCH=${{ matrix.branch }}
          export REGISTRY=${{ env.REGISTRY }}
          export AUTHOR=${{ env.AUTHOR }}
          export NAME=${{ env.NAME }}
          make publish_qemu
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: qemu-logs-${{ matrix.branch }}
          path: |
            /tmp/qemu-*.log
          if-no-files-found: ignore

  summary:
  publish-qemu-extras:
    runs-on: ubuntu-latest
    needs: [publish-qemu-base, publish-qemu-extras]-base
    strategy:
      fail-fast: false
      matrix:
        branch:
          - featured/kathara
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          make set_type TYPE=base

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-system-arm \
            qemu-utils \
            cloud-image-utils \
            ansible \
            sshpass \
            rsync \
            python3-pip
          pip3 install vcstool

      - name: Cache QEMU files
        uses: actions/cache@v3
        with:
          path: |
            .cache/qemu_files
            .cache/qemu_images
          key: qemu-cache-${{ runner.os }}-${{ hashFiles('scripts/shell/prepare_qemu_files.sh', 'scripts/shell/prepare_qemu_images.sh') }}
          restore-keys: |
            qemu-cache-${{ runner.os }}-

      - name: Build and publish QEMU image for ${{ matrix.branch }}
        run: |
          export BRANCH=${{ matrix.branch }}
          export REGISTRY=${{ env.REGISTRY }}
          export AUTHOR=${{ env.AUTHOR }}
          export NAME=${{ env.NAME }}
          make publish_qemu
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: qemu-logs-${{ matrix.branch }}
          path: |
            /tmp/qemu-*.log
          if-no-files-found: ignore

    runs-on: ubuntu-latest
    needs: publish-qemu
    if: always()
    steps:
      - name: Job Summary
        run: |
          echo "## QEMU Images Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… QEMU images build and publish workflow completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ env.AUTHOR }}/${{ env.NAME }}-qemu" >> $GITHUB_STEP_SUMMARY
