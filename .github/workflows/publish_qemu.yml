name: Build and Publish QEMU Images

on:
  workflow_dispatch:
  release:
    types: [published]

env:
  REGISTRY: docker.io
  AUTHOR: davidliyutong
  NAME: idekube-container

jobs:
  publish-qemu-base:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch:
          - featured/base
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          make set_type TYPE=base

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-system-aarch64 \
            qemu-utils \
            cloud-image-utils \
            ansible \
            sshpass \
            rsync \
            python3-pip
          pip3 install vcstool

      - name: Cache QEMU files
        uses: actions/cache@v3
        with:
          path: |
            .cache/qemu_files
            .cache/qemu_images
          key: qemu-cache-${{ runner.os }}-${{ hashFiles('scripts/shell/prepare_qemu_files.sh', 'scripts/shell/prepare_qemu_images.sh') }}
          restore-keys: |
            qemu-cache-${{ runner.os }}-

      - name: Build and publish QEMU image for ${{ matrix.branch }}
        run: |
          export BRANCH=${{ matrix.branch }} && make publish_qemu

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: qemu-logs-${{ matrix.branch }}
          path: |
            /tmp/qemu-*.log
          if-no-files-found: ignore

  publish-qemu-extras:
    runs-on: ubuntu-latest
    needs: [publish-qemu-base]
    strategy:
      fail-fast: false
      matrix:
        branch:
          - featured/kathara
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          make set_type TYPE=base

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-system-aarch64 \
            qemu-utils \
            cloud-image-utils \
            ansible \
            sshpass \
            rsync \
            python3-pip
          pip3 install vcstool

      - name: Cache QEMU files
        uses: actions/cache@v3
        with:
          path: |
            .cache/qemu_files
            .cache/qemu_images
          key: qemu-cache-${{ runner.os }}-${{ hashFiles('scripts/shell/prepare_qemu_files.sh', 'scripts/shell/prepare_qemu_images.sh') }}
          restore-keys: |
            qemu-cache-${{ runner.os }}-

      - name: Build and publish QEMU image for ${{ matrix.branch }}
        run: |
          export BRANCH=${{ matrix.branch }} && make publish_qemu

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: qemu-logs-${{ matrix.branch }}
          path: |
            /tmp/qemu-*.log
          if-no-files-found: ignore